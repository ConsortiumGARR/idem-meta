<?xml version="1.0" encoding="UTF-8"?>
<!--
    Common beans for this channel.
-->
<beans xmlns="http://www.springframework.org/schema/beans"
    xmlns:util="http://www.springframework.org/schema/util"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="
        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
        http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util-3.0.xsd">

    <!--
        uk_fetchFragmentFiles
        
        Collects all the UK metadata "fragment files" from the /entities directory.
        
        Each fragment file contains a single EntityDescriptor.  The name of each
        eligible file matches a particular regular expression.
    -->
    <bean id="uk_fetchFragmentFiles" class="net.shibboleth.metadata.dom.DomFilesystemSourceStage"
        init-method="initialize" lazy-init="true">
        <property name="id" value="uk_fetchFragmentFiles"/>
        <property name="parserPool" ref="parserPool"/>
        <property name="source">
            <bean class="java.io.File">
                <constructor-arg value="#{ systemProperties['basedir'] }/entities"/>
            </bean>
        </property>
        <property name="sourceFileFilter">
            <bean class="uk.org.ukfederation.mda.RegexFileFilter">
                <constructor-arg value="uk\d{6}.xml"/>
            </bean>
        </property>
    </bean>
    
    
    <!--
        uk_filterDeletedEntities
        
        Remove entity items which have the ukfedlabel:DeletedEntity label on them.
        This convention will be replaced at some point by the files not being available
        for collection in the first place.
    -->
    <bean id="uk_filterDeletedEntities" class="net.shibboleth.metadata.dom.XPathFilteringStage"
        init-method="initialize" lazy-init="true">
        <property name="id" value="uk_filterDeletedEntities"/>
        <constructor-arg name="expression" value="//ukfedlabel:DeletedEntity"/>
        <constructor-arg name="context" ref="commonNamespaces"/>
    </bean>
    
    
    <!--
        uk_processScopes
        
        This stage normalises scope handling in two ways particular to the UK
        federation:
        
        * we make all three potential scope lists equivalent (on the entity, on
        the IDPSSODescriptor and on the AttributeAuthority)
        
        * we inject scopes "pushed" to entities from the members.xml file
        
        This transform can be run on individual EntityDescriptors or on an
        aggregate EntitiesDescriptor.
    -->
    <bean id="uk_processScopes" class="net.shibboleth.metadata.dom.XSLTransformationStage"
        init-method="initialize" lazy-init="true">
        <property name="id" value="uk_processScopes"/>
        <property name="xslResource">
            <bean class="org.opensaml.util.resource.FilesystemResource">
                <constructor-arg value="#{ systemProperties['basedir'] }/mdx/uk/scopes.xsl"/>
            </bean>
        </property>
        <property name="transformParameters">
            <map>
                <entry key="members" value-ref="uk_members"/>
            </map>
        </property>
    </bean>
    
    
    <!--
        uk_membersResource
        
        A Resource referencing the members.xml document.
    -->
    <bean id="uk_membersResource" class="org.opensaml.util.resource.FilesystemResource" lazy-init="true">
        <constructor-arg value="#{ systemProperties['basedir'] }/xml/members.xml"/>
    </bean>
    
    
    <!--
        uk_membersDocument
        
        This bean contains the contents of the members.xml file as a DOM Document.
    -->
    <bean id="uk_membersDocument" class="net.shibboleth.ext.spring.factory.DomDocumentFactoryBean" lazy-init="true">
        <property name="documentResource" ref="uk_membersResource"/>
        <property name="parserPool" ref="parserPool"/>
    </bean>
    
    
    <!--
        uk_members
        
        This bean implements an API for access to the contents of the members.xml document.
    -->
    <bean id="uk_members" class="uk.org.ukfederation.members.Members" lazy-init="true">
        <constructor-arg>
            <bean class="java.io.File">
                <constructor-arg value="#{ systemProperties['basedir'] }/xml/members.xml"/>
            </bean>
        </constructor-arg>
    </bean>
    
    
    <!--
        check_ukreg
        
        Checks specific to the UK registrar function.
    -->
    <bean id="check_ukreg" class="net.shibboleth.metadata.dom.XSLValidationStage"
        init-method="initialize" lazy-init="true">
        <property name="id" value="check_ukreg"/>
        <property name="xslResource">
            <bean class="org.opensaml.util.resource.FilesystemResource">
                <constructor-arg value="#{ systemProperties['basedir'] }/build/check_ukreg_mda.xsl"/>
            </bean>
        </property>
        <property name="transformParameters">
            <map>
                <entry key="members" value-ref="uk_members"/>
            </map>
        </property>
    </bean>
    
    
    <!--
        uk_trustRootsDocument
        
        This bean contains the contents of the master.xml file as a DOM Document.
    -->
    <bean id="uk_trustRootsDocument" class="net.shibboleth.ext.spring.factory.DomDocumentFactoryBean"
        lazy-init="true">
        <property name="parserPool" ref="parserPool"/>
        <property name="documentResource">
            <bean class="org.opensaml.util.resource.FilesystemResource">
                <constructor-arg value="#{ systemProperties['basedir'] }/xml/master.xml"/>
            </bean>
        </property>
    </bean>    
    
    
    <!--
        uk_addTrustRoots
        
        This stage adds the UK federation trust roots to an EntitiesDescriptor.
    -->
    <bean id="uk_addTrustRoots" class="net.shibboleth.metadata.dom.XSLTransformationStage"
        init-method="initialize" lazy-init="true">
        <property name="id" value="uk_addTrustRoots"/>
        <property name="xslResource">
            <bean class="org.opensaml.util.resource.FilesystemResource">
                <constructor-arg value="#{ systemProperties['basedir'] }/mdx/uk/trust-roots.xsl"/>
            </bean>
        </property>
        <property name="transformParameters">
            <map>
                <entry key="trustRootsDocument" value-ref="uk_trustRootsDocument"/>
            </map>
        </property>
    </bean>
    

    <!--
        uk_processFragment
        
        This stage performs any standard cleanup required for UK federation fragment files.
    -->
    <bean id="uk_processFragment" class="net.shibboleth.metadata.dom.XSLTransformationStage"
        init-method="initialize" lazy-init="true">
        <property name="id" value="uk_processFragment"/>
        <property name="xslResource">
            <bean class="org.opensaml.util.resource.FilesystemResource">
                <constructor-arg value="#{ systemProperties['basedir'] }/mdx/uk/fragment.xsl"/>
            </bean>
        </property>
    </bean>
    
    
    <!--
        uk_performFixups
        
        This stage performs any fixup actions required before publication to UK federation members.
    -->
    <bean id="uk_performFixups" class="net.shibboleth.metadata.dom.XSLTransformationStage"
        init-method="initialize" lazy-init="true">
        <property name="id" value="uk_performFixups"/>
        <property name="xslResource">
            <bean class="org.opensaml.util.resource.FilesystemResource">
                <constructor-arg value="#{ systemProperties['basedir'] }/mdx/uk/fixups.xsl"/>
            </bean>
        </property>
    </bean>
    
    
    <!--
        Populate UKId values from entities.
    -->
    <bean id="uk_populateIds" class="uk.org.ukfederation.mda.EntityDescriptorUKIdPopulationStage"
        init-method="initialize" lazy-init="true">
        <property name="id" value="uk_populateIds"/>
    </bean>
    

    <!--
        UK federation EntitiesDescriptor assembler pipeline stage.
    -->
    <bean id="uk_assemble" class="net.shibboleth.metadata.dom.saml.EntitiesDescriptorAssemblerStage"
        init-method="initialize" lazy-init="true">
        <property name="id" value="uk_assemble"/>
        <property name="descriptorName" value="http://ukfederation.org.uk"/>
        <property name="itemOrderingStrategy">
            <bean class="uk.org.ukfederation.mda.UKEntityOrderingStrategy"/>
        </property>
    </bean>
    

    <!--
        Fetch and process the registered entities as a collection.
    -->
    <bean id="uk_registeredEntities" class="net.shibboleth.metadata.pipeline.CompositeStage"
        init-method="initialize" lazy-init="true">
        <property name="id" value="uk_registeredEntities"/>
        <property name="composedStages">
            <list>
                <ref bean="uk_fetchFragmentFiles"/>
                <ref bean="uk_filterDeletedEntities"/>
                <ref bean="uk_processFragment"/>
                <ref bean="uk_processScopes"/>
                <ref bean="populateItemIds"/>
                <ref bean="uk_populateIds"/>
                <ref bean="checkSchemas"/>
                <ref bean="CHECK_std"/>
                <ref bean="check_ukreg"/>
                
                <!-- failure of any check on registered metadata is fatal -->
                <ref bean="errorTerminatingFilter"/>
            </list>
        </property>
    </bean>
    

    <!--
        uk_normaliseNamespaces
        
        A pipeline stage that can be used before serialisation to normalise the namespaces
        used in an XML document.  This one is UK-specific, as it makes specific choices
        in order to limit the number of prefixes used.
    -->
    <bean id="uk_normaliseNamespaces" class="net.shibboleth.metadata.dom.XSLTransformationStage"
        init-method="initialize" lazy-init="true">
        <property name="id" value="uk_normaliseNamespaces"/>
        <property name="xslResource">
            <bean class="org.opensaml.util.resource.FilesystemResource">
                <constructor-arg value="#{ systemProperties['basedir'] }/build/ns_norm_uk.xsl"/>
            </bean>
        </property>
    </bean>
    

</beans>
