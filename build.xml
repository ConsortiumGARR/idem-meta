<?xml version="1.0" encoding="UTF-8"?>

<!--
	Federation metadata signing process for the UK federation.
	
	* "ant process" generates the other files from the master file, and
	  signs as appropriate.  Requires the keystore password.
	  
	* "ant push" sends all files to the remote site, and requires
	  the remote site password.
-->
<project default="process">
    
	<!--
		Accessing the remote system.
	-->
	<property name="remote.host" value="bodach.ucs.ed.ac.uk"/>
	<property name="remote.user" value="sdssweb"/>
	<property name="remote.dir.sdss" value="dev/fed"/>
	<property name="remote.loc.sdss" value="${remote.user}@${remote.host}:${remote.dir.sdss}"/>
	<property name="remote.dir.uk" value="metadata"/>
	<property name="remote.loc.uk" value="${remote.user}@${remote.host}:${remote.dir.uk}"/>
	<property name="remote.url" value="http://master.metadata.ukfederation.org.uk"/>

	<!--
		Local specialised directories.
	-->
	<property name="build.dir" value="${basedir}/build"/>
	<property name="entities.dir" value="entities"/>
	<property name="bin.dir" value="bin"/>
	<property name="lib.dir" value="lib"/>
	<property name="templates.dir" value="templates"/>
	<property name="xalan.dir" value="xalan-j_2_6_0"/>
	<property name="xml.dir" value="xml"/>

	<!--
		Endorsed libraries.
	-->
	<!-- endorsed libraries for metadatatool -->
	<property name="endorsed.mdt.dir" value="endorsed-mdt"/>
	<!-- endorsed libraries for everything except metadatatool -->
	<property name="endorsed.dir" value="endorsed"/>
	
	<!--
		Additional ANT task definitions.
	-->
	<taskdef resource="net/sf/antcontrib/antlib.xml">
		<classpath>
			<pathelement location="${lib.dir}/ant-contrib-1.0b3.jar"/>
		</classpath>
	</taskdef>
	
	<!--
		The first phase in the signing process is to concatenate the
		individual entity fragment files (uk*.xml in the entities directory)
		together and enclose them in an <Entities> element.
		
		The resulting file [1] entities.xml contains *all* entities,
		even deleted ones, and contains some information we don't ultimately
		want to publish.  entities.xml itself is neither stored
		in the repository nor published.
	-->
	<property name="entities.file.dir" value="${xml.dir}"/>
	<property name="entities.file.name" value="entities.xml"/>
	<property name="entities.file" value="${entities.file.dir}/${entities.file.name}"/>

	<!--
		The master file contains the UK federation's KeyAuthority descriptors.
	-->
	<property name="master.file.dir" value="${xml.dir}"/>
	<property name="master.file.name" value="master.xml"/>
	<property name="master.file" value="${master.file.dir}/${master.file.name}"/>
	
	<!--
		The full, unfiltered entities.xml is combined with the UK federation
		trust roots (from master.xml) to produce the "UK federation master file"
		([2] ukfederation-metadata-master.xml).  This drops entities marked as
		deleted.  Although the file by this stage conforms to UK federation
		conventions, it may still contain information not intended for
		publication.
	-->
	<property name="uk.master.file" value="ukfederation-metadata-master.xml"/>
	
	<!--
		The UK federation master file acts as the parent to four separate processing
		"streams":  production, test, export and fallback.  The fifth "wayf" stream
		is derived from the production stream.
		
		Each stream has its own XSLT transform and its own unsigned file, as follows:
	-->
	<property name="md.prod.unsigned"   value="ukfederation-metadata-unsigned.xml"/>
	<property name="md.test.unsigned"   value="ukfederation-test-unsigned.xml"/>
	<property name="md.export.unsigned" value="ukfederation-export-unsigned.xml"/>
	<property name="md.back.unsigned"   value="ukfederation-back-unsigned.xml"/>
	<property name="md.wayf.unsigned"   value="ukfederation-wayf-unsigned.xml"/>
	
	<!--
		Each stream has its own signed file.
	-->
	<property name="md.prod.signed"     value="ukfederation-metadata.xml"/>
	<property name="md.test.signed"     value="ukfederation-test.xml"/>
	<property name="md.export.signed"   value="ukfederation-export.xml"/>
	<property name="md.back.signed"     value="ukfederation-back.xml"/>
	<property name="md.wayf.signed"     value="ukfederation-wayf.xml"/>
	
	<!--
		The process (with indentation implying the creation
		hierarchy) is:
		
		[19]	ukfederation-metadata-unsigned.xml
		[20]		ukfederation-metadata.xml
		[21]		ukfederation-sites-12-unsigned.xml
		[22]			ukfederation-sites-12.xml
		[23]		ukfederation-trust-12-unsigned.xml
		[24]			ukfederation-trust-12.xml
		[25]		ukfederation-wayf-unsigned.xml
		[26]			ukfederation-wayf.xml
		
		[27]	ukfederation-test-unsigned.xml
		[28]		ukfederation-test.xml
		[29]	ukfederation-export-unsigned.xml
		[30]		ukfederation-export.xml
		[31]    ukfederation-back-unsigned.xml
		[32]        ukfederation-back.xml
		
		The numbers in brackets are duplicated in the script where the file in
		question is created.  Some numbers are missing because some old format
		files are no longer being generated.
	-->

	<!--
		Null device location.
	-->
	<condition property="null.device"
		value="nul:" else="/dev/null">
		<os family="windows"/>
	</condition>

	<!--
		Signing keystore type.
		
		On Windows, we use a hard token accessed through PKCS#11.
		On Mac, we use a Java Keystore.
	-->
	<condition property="keystore.uk.sign.type"
		value="PKCS11" else="JKS">
		<os family="windows"/>
	</condition>

	<!--
		Signing keystore location.
		
		On Windows, because we're using PKCS#11, we use an explicit NONE.
		Otherwise, the keystore lives on the UK_KEYS volume.
	-->
	<condition property="keystore.uk.sign.loc"
		value="NONE" else="/Volumes/UK_KEYS/ukfederation-sign.jks">
		<os family="windows"/>
	</condition>

	<!--
		Signing keystore alias.
	-->
	<property name="keystore.uk.sign.alias" value="ukfederation"/>

	<!--
		Verification keystore.
	-->
	<property name="keystore.uk.vfy.loc" value="${build.dir}/ukfederation.jks"/>
	<property name="keystore.uk.vfy.alias" value="ukfederation"/>
	
	<property name="known.hosts" value="${build.dir}/known_hosts"/>

	<!--
		*************************************************
		***                                           ***
		***   E N T R Y   P O I N T   T A R G E T S   ***
		***                                           ***
		*************************************************
	-->
	
	<!--
		Standard processing: generate, sign, then verify.
	-->
	<target name="process" depends="get.keystore.pass, generate, sign, verify, stats">
		<echo>Processing complete.</echo>
	</target>
	
	<!--
		After standard processing, push: get password, push files, verify them.
	-->
	<target name="push" depends="get.remote.pass, push.files, verify.remote.metadata">
		<echo>Data pushed and verified.</echo>
	</target>

	<!--
		*************************************
		***                               ***
		***   M E T A D A T A   P U S H   ***
		***                               ***
		*************************************
	-->

	<!--
		Acquire the remote password.
	-->
	<target name="get.remote.pass" unless="remote.pass">
		<input addproperty="remote.pass">
			Please enter the password for ${remote.user} on ${remote.host}:
		</input>
	</target>

	<!--
		Push all generated XML files, and entity fragment files, to the remote machine.
	-->
	<target name="push.files" depends="get.remote.pass">
		<!--
			Push metadata files to the old SDSS federation location.
			
			Nowadays, these are not SDSS federation metadata files but other
			miscellaneous files such as UK federation statistics.
		-->
		<echo>Pushing non-metadata files.</echo>
		<scp failonerror="true" password="${remote.pass}" remoteTodir="${remote.loc.sdss}"
				knownhosts="${known.hosts}">
			<fileset dir="${xml.dir}">
				<include name="members.xml"/>
				<include name="ukfederation-members.xsd"/>
				<include name="ukfederation-stats.html"/>
			</fileset>
		</scp>
		<!--
			Push metadata files for the UK Federation.
		-->
		<echo>Pushing UK Federation metadata files.</echo>
		<scp failonerror="true" password="${remote.pass}" remoteTodir="${remote.loc.uk}"
				knownhosts="${known.hosts}">
			<fileset dir="${xml.dir}">
				<include name="${md.prod.signed}"/>
				<include name="ukfederation-sites-12.xml"/>
				<include name="ukfederation-trust-12.xml"/>
				<include name="${md.wayf.signed}"/>
				<include name="${md.test.signed}"/>
				<include name="${md.back.signed}"/>
			</fileset>
		</scp>
	</target>

	<!--
		Verify a metadata file held on the master distribution site.
	-->
	<macrodef name="VFY.remote">
		<attribute name="i"/>
		<sequential>
			<echo>Verifying @{i}...</echo>
			<delete file="${xml.dir}/temp.xml" quiet="true" verbose="false"/>
			<get src="${remote.url}/@{i}" dest="${xml.dir}/temp.xml"/>
			<MDT i="temp.xml" o="${null.device}" keystore="${keystore.uk.vfy.loc}" alias="${keystore.uk.vfy.alias}"/>
			<delete file="${xml.dir}/temp.xml" quiet="true" verbose="false"/>
		</sequential>
	</macrodef>
	
	<!--
		Verify a metadata file held on the master distribution site.
	-->
	<target name="verify.remote.metadata">
		<echo>Verifying metadata held at ${remote.url}</echo>
		<VFY.remote i="${md.prod.signed}"/>
		<VFY.remote i="ukfederation-sites-12.xml"/>
		<VFY.remote i="ukfederation-trust-12.xml"/>
		<VFY.remote i="${md.wayf.signed}"/>
		<VFY.remote i="${md.test.signed}"/>
		<VFY.remote i="${md.back.signed}"/>
		<echo>Verification completed.</echo>
	</target>
	
	<!--
		*************************************************
		***                                           ***
		***   M E T A D A T A   G E N E R A T I O N   ***
		***                                           ***
		*************************************************
	-->
	
	<!--
		Generate unsigned metadata.
	-->
	<target name="generate" depends="gen.uk">
		<echo>Generated unsigned metadata.</echo>
	</target>
	
	<!--
		Macro to run the Xalan XSLT engine, taking files from pre-defined
		locations.
	-->
	<macrodef name="XALAN">
		<attribute name="i"/>
		<attribute name="o"/>
		<attribute name="x"/>
		<sequential>
			<java fork="true" maxmemory="384m" failonerror="true" classname="org.apache.xalan.xslt.Process">
				<classpath>
					<pathelement location="${xalan.dir}/bin/xalan.jar"/>
					<pathelement location="${lib.dir}/joda-time-1.6.jar"/>
					<pathelement path="${bin.dir}"/>
				</classpath>
				<arg value="-IN"/>
				<arg value="${xml.dir}/@{i}"/>
				<arg value="-OUT"/>
				<arg value="${xml.dir}/@{o}"/>
				<arg value="-XSL"/>
				<arg value="${build.dir}/@{x}"/>
			</java>
		</sequential>
	</macrodef>

	<!--
		gen.entities
		
		Concatenates the (potentially many) entity fragment files together into a single file
		wrapping the entities in an <Entities> element.  This can then be dragged in by the document
		function in XSLT.
	-->
	<target name="gen.entities">
		<echo>Composing entity fragment files.</echo>
		<!-- [1] -->
		<concat destfile="${entities.file}" append="no" force="yes" fixlastline="no">
			<header filtering="no">&lt;?xml version="1.0" encoding="UTF-8"?&gt;&#10;&lt;Entities&gt;&#10;</header>
			<fileset dir="${entities.dir}" includes="uk*.xml"/>
			<footer>&lt;/Entities&gt;&#10;</footer>
			<filterchain>
				<replaceregex pattern="&lt;\?[xX][mM][lL] .*&gt;" />
			</filterchain>
		</concat>
	</target>
	
	<!--
		Unsigned metadata generation for the UK Federation.
	-->

	<target name="gen.uk" depends="gen.uk.unsigned, gen.uk.1.2, gen.uk.wayf">
		<echo>Generated UK unsigned metadata.</echo>
	</target>

	<target name="gen.uk.master" depends="gen.entities">
		<echo>Generating UK federation master file.</echo>
		<!-- [2] -->
		<XALAN x="master_ukfederation.xsl" i="${master.file.name}"
			o="${uk.master.file}" />
		<CHECK i="${xml.dir}/${uk.master.file}" s="check.xsl"/>
	</target>
	
	<target name="gen.uk.unsigned" depends="gen.uk.master">
		<echo>Generating unsigned UK metadata files.</echo>
		<!-- [19] -->
		<XALAN x="uk_master_unsigned.xsl" i="${uk.master.file}"
			o="${md.prod.unsigned}" />
		<!-- [27] -->
		<XALAN x="uk_master_test.xsl" i="${uk.master.file}"
			o="${md.test.unsigned}" />
		<!-- [29] -->
		<XALAN x="uk_master_export.xsl" i="${uk.master.file}"
			o="${md.export.unsigned}" />
		<!-- [31] -->
		<XALAN x="uk_master_back.xsl" i="${uk.master.file}"
			o="${md.back.unsigned}" />
	</target>
	
	<target name="gen.uk.1.2" depends="gen.uk.unsigned">
		<echo>Generating unsigned UK V1.2 metadata.</echo>
		<!-- [21] -->
		<XALAN x="v13_to_v12_sites.xsl" i="${uk.metadata.unsigned}"
			o="ukfederation-sites-12-unsigned.xml"/>
		<!-- [23] -->
		<XALAN x="v13_to_v12_trust.xsl" i="${uk.metadata.unsigned}"
			o="ukfederation-trust-12-unsigned.xml"/>
	</target>
	
	<target name="gen.uk.wayf" depends="gen.uk.unsigned">
		<echo>Generating unsigned UK WAYF metadata.</echo>
		<!-- [25] -->
		<XALAN x="master_to_wayf.xsl" i="${uk.metadata.unsigned}"
			o="${md.wayf.unsigned}"/>
	</target>

	<!--
		*******************************************
		***                                     ***
		***   M E T A D A T A   S I G N I N G   ***
		***                                     ***
		*******************************************
	-->
	
	<!--
		Acquire the keystore password.
	-->
	<target name="get.keystore.pass" unless="keystore.pass">
		<input addproperty="keystore.pass">
			Please enter the password for the keystores:
		</input>
	</target>

	<!--
		Macro to run the metadatatool application with appropriate defaults.
	-->
	<macrodef name="MDT">
		<attribute name="i"/><!-- input file, assumed to be in the XML directory -->
		<attribute name="o"/><!-- output file location -->
		<attribute name="keystore"/><!-- keystore file location -->
		<attribute name="storetype" default="JKS"/><!-- type of keystore to use -->
		<attribute name="alias"/><!-- alias of key to use -->
		<element name="args" optional="yes"/>
		<sequential>
			<java classname="edu.internet2.middleware.shibboleth.utils.MetadataTool"
				fork="true" failonerror="true" maxmemory="384m">
				<classpath>
					<fileset dir="${lib.dir}">
						<include name="**/*.jar"/>
					</fileset>
				</classpath>
				<!--
					metadatatool requires its own variant of
					the endorsed libraries.
				-->
				<jvmarg value="-Djava.endorsed.dirs=${endorsed.mdt.dir}"/>
				<!--
				<jvmarg value="-Dlog4j.configuration=log4j.properties"/>
				-->
				<args/>
				<arg value="--keystore"/>
				<arg value="@{keystore}"/>
				<arg value="--storetype"/>
				<arg value="@{storetype}"/>
				<arg value="--alias"/>
				<arg value="@{alias}"/>
				<arg value="--in"/>
				<arg value="${xml.dir}/@{i}"/>
				<arg value="--out"/>
				<arg value="@{o}"/>
			</java>
		</sequential>
	</macrodef>
	
	<!--
		Sign the various metadata files.
	-->
	
	<macrodef name="SIGN.uk">
		<attribute name="i"/>
		<attribute name="o"/>
		<sequential>
			<MDT i="@{i}" o="${xml.dir}/@{o}"
				keystore="${keystore.uk.sign.loc}"
				storetype="${keystore.uk.sign.type}"
				alias="${keystore.uk.sign.alias}">
				<args>
					<arg value="--sign"/>
					<arg value="--password"/>
					<arg value="${keystore.pass}"/>
				</args>
			</MDT>
		</sequential>
	</macrodef>
	
	<target name="sign">
		<echo>Signing UK metadata.</echo>
		<!-- [20] -->
		<SIGN.uk i="${md.prod.unsigned}" o="${md.prod.signed}"/>

		<echo>Signing UK V1.2 metadata.</echo>
		<!-- [22] -->
		<SIGN.uk i="ukfederation-sites-12-unsigned.xml"
			o="ukfederation-sites-12.xml"/>
		<!-- [24] -->
		<SIGN.uk i="ukfederation-trust-12-unsigned.xml"
			o="ukfederation-trust-12.xml"/>

		<echo>Signing UK WAYF metadata.</echo>
		<!-- [26] -->
		<SIGN.uk i="${md.wayf.unsigned}" o="${md.wayf.signed}"/>

		<echo>Signing UK test metadata.</echo>
		<!-- [28] -->
		<SIGN.uk i="${md.test.unsigned}" o="${md.test.signed}"/>

		<echo>Signing UK export metadata.</echo>
		<!-- [30] -->
		<SIGN.uk i="${md.export.unsigned}" o="${md.export.signed}"/>

		<echo>Signing UK fallback metadata.</echo>
		<!-- [32] -->
		<SIGN.uk i="${md.back.unsigned}" o="${md.back.signed}"/>
		
		<echo>Generated signed UK metadata.</echo>
	</target>
	
	<!--
		Verification of the UK Federation metadata.
	-->
	<macrodef name="VFY.uk">
		<attribute name="i"/>
		<sequential>
			<MDT i="@{i}" o="${null.device}" keystore="${keystore.uk.vfy.loc}" alias="${keystore.uk.vfy.alias}"/>
		</sequential>
	</macrodef>
		
	<!--
		Verify the signed metadata files.
	-->
	<target name="verify">
		<echo>Verifying signed UK metadata.</echo>
		<VFY.uk i="${md.prod.signed}"/>

		<echo>Verifying signed UK V1.2 metadata.</echo>
		<VFY.uk i="ukfederation-sites-12.xml"/>
		<VFY.uk i="ukfederation-trust-12.xml"/>

		<echo>Verifying signed UK WAYF metadata.</echo>
		<VFY.uk i="${md.wayf.signed}"/>

		<echo>Verifying signed UK test metadata.</echo>
		<VFY.uk i="${md.test.signed}"/>

		<echo>Verifying signed UK export metadata.</echo>
		<VFY.uk i="${md.export.signed}"/>
		
		<echo>Verifying signed UK fallback metadata.</echo>
		<VFY.uk i="${md.back.signed}"/>

		<echo>Verification completed.</echo>
	</target>
	
	<!--
		*****************************************
		***                                   ***
		***   M E T A D A T A   I M P O R T   ***
		***                                   ***
		*****************************************
	-->
	
	<target name="import.metadata">
		<echo>Importing metadata from ${entities.dir}/import.xml</echo>
		<java fork="true" maxmemory="384m" failonerror="true" classname="org.apache.xalan.xslt.Process">
			<classpath>
				<pathelement location="${lib.dir}/joda-time-1.6.jar"/>
				<pathelement path="${bin.dir}"/>
			</classpath>
			<jvmarg value="-Djava.endorsed.dirs=${endorsed.dir}"/>
			<arg value="-IN"/>
			<arg value="${entities.dir}/import.xml"/>
			<arg value="-OUT"/>
			<arg value="${entities.dir}/imported.xml"/>
			<arg value="-XSL"/>
			<arg value="${build.dir}/import.xsl"/>
		</java>
		<echo>Imported metadata to ${entities.dir}/imported.xml</echo>
		<CHECK i="${entities.dir}/imported.xml" s="check_imported.xsl"/>
		<echo>Checked.</echo>
	</target>
	
	<!--
		*****************************************
		***                                   ***
		***   M E T A D A T A   C H E C K S   ***
		***                                   ***
		*****************************************
	-->
	
	<!--
		Check a metadata document against a set of conventions.
		
		Parameter 'i' is the file to be checked; no assumption is made
		about its location so this must contain a full path.
		
		Parameter 's' is the checking stylesheet to use; assumed to be
		present in the build.dir.
	-->
	<macrodef name="CHECK">
		<attribute name="i"/>
		<attribute name="s"/>
		<sequential>
			<java classname="uk.org.ukfederation.apps.mdcheck.MetadataCheck"
				fork="true" failonerror="true" maxmemory="384m">
				<classpath>
					<pathelement location="${lib.dir}/joda-time-1.6.jar"/>
					<pathelement path="${bin.dir}"/>
				</classpath>
				<jvmarg value="-Djava.endorsed.dirs=${endorsed.dir}"/>
				<arg value="@{i}"/>
				<arg value="${build.dir}/@{s}"/>
			</java>
		</sequential>
	</macrodef>
	
	<!--
		*******************************
		***                         ***
		***   M I S C E L L A N Y   ***
		***                         ***
		*******************************
	-->
	
	<!--
		Statistics generation
		
		Note that statistics are generated from the UK federation master file,
		so that the statistics process has access to information that will not
		be included in published metadata.
	-->
	<target name="stats" depends="gen.uk.unsigned">
		<echo>Generating UK Federation statistics</echo>
		<XALAN
			i="${uk.master.file}"
			o="ukfederation-stats.html"
			x="statistics.xsl"/>
		<fixcrlf file="${xml.dir}/ukfederation-stats.html" eol="lf"/>
	</target>
	
	<!--
		Check mailing list against current metadata
	-->
	<target name="check.mailing.list" depends="gen.uk.master">
		<echo>Checking mailing list entries.</echo>
		<exec executable="perl" dir="${build.dir}">
			<arg value="${build.dir}/addresses.pl"/>
		</exec>
	</target>
	
	<!--
		Extract TLS locations from the UK federation metadata.
	-->
	<target name="extract.locs" depends="gen.uk.unsigned">
		<echo>Extracting TLS locations</echo>
		<exec executable="perl" dir="${build.dir}"
			output="${build.dir}/locations.txt">
			<arg value="${build.dir}/extract_locs.pl"/>
		</exec>
	</target>
	
	<!--
		Extract authorities
	-->
	<target name="extract.authorities">
		<echo>Extracting key authorities</echo>
		<XALAN
			i="master.xml"
			o="authorities.pem"
			x="extract_authorities.xsl"/>
	</target>
	
	<!--
		Check authorities
	-->
	<target name="check.authorities">
		<echo>Checking authority certificates</echo>
		<exec executable="perl" dir="${xml.dir}"
			input="${xml.dir}/authorities.pem">
			<arg value="${build.dir}/check_authorities.pl"/>
		</exec>
	</target>

	<!--
		Extract member list for joining date backfill.
	-->
	<target name="extract.member.dates">
		<echo>Extracting member dates</echo>
		<XALAN
			i="members.xml"
			o="member-dates.txt"
			x="extract_member_dates.xsl"/>
	</target>

	<!--
		Utility to fold overlong embedded certificates.
	-->
	<target name="fold.embedded.certs">
		<echo>Folding embedded certificates</echo>
		<for param="file">
			<path>
				<fileset dir="${entities.dir}" includes="uk*.xml"/>
			</path>
			<sequential>
				<exec executable="perl" dir="${entities.dir}">
					<arg value="-i"/>
					<arg value="${build.dir}/fold_cert.pl"/>
					<arg value="@{file}"/>
				</exec>
			</sequential>
		</for>
	</target>
	
	<!--
		Utility to remove the old Eduserv gateway certificate.
	-->
	<!--
	<target name="remove.old.eduserv.cert">
		<echo>Removing old Eduserv gateway certificate</echo>
		<for param="file">
			<path>
				<fileset dir="${entities.dir}" includes="uk*.xml"/>
			</path>
			<sequential>
				<exec executable="perl" dir="${entities.dir}">
					<arg value="-i"/>
					<arg value="${build.dir}/remove_old_eduserv_cert.pl"/>
					<arg value="@{file}"/>
				</exec>
			</sequential>
		</for>
	</target>
	-->
	
	<!--
		Utility to add the second Eduserv gateway certificate.
	-->
	<!--
	<target name="add.second.eduserv.cert">
		<echo>Adding second Eduserv gateway certificate</echo>
		<for param="file">
			<path>
				<fileset dir="${entities.dir}" includes="uk*.xml"/>
			</path>
			<sequential>
				<exec executable="perl" dir="${entities.dir}">
					<arg value="-i"/>
					<arg value="${build.dir}/add_second_eduserv_cert.pl"/>
					<arg value="@{file}"/>
				</exec>
			</sequential>
		</for>
	</target>
	-->
	
	<!--
		Extract embedded certificates
	-->
	<target name="extract.embedded" depends="gen.uk">
		<echo>Extracting embedded certificates</echo>
		<XALAN
			i="${md.prod.unsigned}"
			o="embedded.pem"
			x="extract_embedded.xsl"/>
	</target>
	
	<!--
		Check embedded certificates.
	-->
	<target name="check.embedded" depends="extract.embedded">
		<echo>Checking embedded certificates</echo>
		<exec executable="perl" dir="${xml.dir}"
			input="${xml.dir}/embedded.pem">
			<arg value="${build.dir}/check_embedded.pl"/>
			<arg value="-q"/>
		</exec>
	</target>
	
</project>