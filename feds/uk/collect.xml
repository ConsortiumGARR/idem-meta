<?xml version="1.0" encoding="UTF-8"?>
<!--
    Pipeline to collect UK-registered entities.
-->
<beans xmlns="http://www.springframework.org/schema/beans"
    xmlns:util="http://www.springframework.org/schema/util"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="
        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
        http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util-3.0.xsd">

    <util:map id="commonNamespaces" map-class="java.util.HashMap">
        <entry key="ds"         value="http://www.w3.org/2000/09/xmldsig#"/>
        <entry key="elab"       value="http://eduserv.org.uk/labels"/>
        <entry key="idpdisc"    value="urn:oasis:names:tc:SAML:profiles:SSO:idp-discovery-protocol"/>
        <entry key="init"       value="urn:oasis:names:tc:SAML:profiles:SSO:request-init"/>
        <entry key="md"         value="urn:oasis:names:tc:SAML:2.0:metadata"/>
        <entry key="mdrpi"      value="urn:oasis:names:tc:SAML:metadata:rpi"/>
        <entry key="mdui"       value="urn:oasis:names:tc:SAML:metadata:ui"/>
        <entry key="saml"       value="urn:oasis:names:tc:SAML:2.0:assertion"/>
        <entry key="shibmd"     value="urn:mace:shibboleth:metadata:1.0"/>
        <entry key="ukfedlabel" value="http://ukfederation.org.uk/2006/11/label"/>
        <entry key="wayf"       value="http://sdss.ac.uk/2006/06/WAYF"/>
        <entry key="xenc"       value="http://www.w3.org/2001/04/xmlenc#"/>
        <entry key="xsi"        value="http://www.w3.org/2001/XMLSchema-instance"/>
        <entry key="xsl"        value="http://www.w3.org/1999/XSL/Transform"/>
    </util:map>

    <bean id="filterDeletedEntities" class="uk.org.ukfederation.mda.XPathFilteringStrategy">
        <constructor-arg name="expression" value="//ukfedlabel:DeletedEntity"/>
        <constructor-arg name="prefixMappings" ref="commonNamespaces"/>
    </bean>
    
    <bean id="fetchUkFragmentFiles" class="net.shibboleth.metadata.dom.stage.DomFilesystemSourceStage">
        <property name="id" value="fetchUkFragmentFiles"/>
        <property name="parserPool">
            <bean class="org.opensaml.util.xml.BasicParserPool" init-method="initialize">
                <property name="ignoreComments" value="false"/>
                <property name="ignoreElementContentWhitespace" value="false"/>
            </bean>
        </property>
        <property name="source">
            <bean class="java.io.File">
                <constructor-arg value="#{ systemProperties['basedir'] }/entities"/>
            </bean>
        </property>
        <property name="sourceFileFilter">
            <bean class="uk.org.ukfederation.mda.RegexFileFilter">
                <constructor-arg value="uk\d{6}.xml"/>
            </bean>
        </property>
        <property name="postProcessFilter" ref="filterDeletedEntities"/>
    </bean>
    
    <!--
    <bean id="members" class="uk.org.ukfederation.members.Members">
        <constructor-arg>
            <bean class="java.io.File">
                <constructor-arg value="#{ systemProperties['basedir'] }/xml/members.xml"/>
            </bean>
        </constructor-arg>
    </bean>
    -->

    <bean id="assemble" class="net.shibboleth.metadata.dom.saml.EntitiesDescriptorAssemblerStage">
        <property name="id" value="assemble"/>
    </bean>

    <bean id="pipeline" class="net.shibboleth.metadata.pipeline.SimplePipeline">
        <property name="id" value="pipeline"/>
        <property name="stages">
            <list>
                <ref bean="fetchUkFragmentFiles"/>
                <ref bean="assemble"/>
            </list>
        </property>
    </bean>
    
    <bean id="serializer" class="net.shibboleth.metadata.dom.DomMetadataSerializer" />

</beans>
